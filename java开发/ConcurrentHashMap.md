# 1. 相关概念
1. `synchronized`：**监视器锁**，在运行过程中也分三种情况
	1. 偏向锁
	2. 轻量级锁
	3. 重量级锁
2. `CAS`：乐观锁，更新失败会不断尝试
3. `volatile`：关键字，修饰的变量被修改后所有线程都能看到修改后的值
4. `自旋锁`：指尝试获取锁的线程在获取失败后不会挂起而是循环尝试
5. `分段锁`：减小锁的粒度，提高并发
# 2. 设计主要思想
1. 减小加锁粒度：segment数组，每个segment内再保存一个hashEntry数组，其中才是真正的键值对![[Pasted image 20240711151828.png]]
2. 读取不加锁，只有写时需要加锁：变量定义使用`volatile`修饰，对变量的修改能被所有线程感知，因此读可以不加锁；写的时候使用`UNSAFE.getOrderedObject`来确保访问到最新值，和`UNSAFE.putOrderedObject`来确保只有完整写完后新值才写入内存被其他线程看见
3. 扩容：需要扩容HashEntry数组大小，使用hashMap的一样的方法，需要加锁处理
4. size()：先无锁遍历，如果两次无锁遍历期间没有put操作，则直接返回获取的size；否则，重试；重试次数超过阈值，则全局加锁获取size