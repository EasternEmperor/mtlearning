# 1. 需求背景
- 研发成本高：目前优选定制化报表有275张，接口3658个，需求量大，开发过程复杂，消耗人力成本高，开发效率低。
- 未来交付模式变化：数据资产作为交付物，期望数据同学主要交付指标&模型标准化沉淀数据资产，取代交付报表，让数据开发同学可以聚焦核心模型开发工作。
- 人员梯队变化：基础高频重复业务需求，未来可能通过更多的内包或外包的人员支撑。
- 分析引擎：分析引擎的结论准确度比较依赖指标的完备程度，依赖接口大量的诊断指标，接口的开发成本非常高，接入效率较低，运维成本高，和大盘无法共用。
# 2. 核心设计理念
1. 简单+高效+可扩展：
	- 基于资产交付：基于起源模型交付看板，无需手写SQL，无需后端编码
	- 单人闭环：单人可以完成基于起源数据应用交付看板全流程，包括数据源配置和UI配置，没有前后端联调工作
	- 可扩展：可以在支持90%通用场景下，拥有一定扩展能力
# 3. 核心流程
1. `appProxy`：入参自检 -> 查询元数据 -> 二次自检 -> 协议转换适配 -> 执行查询 -> 数据脱敏 -> 元数据构建 -> 结果封装 -> 日志落库
## 3.1 查询元数据
1. `rpc`查询数据应用配置 -> 时间、权限、参数等配置
2. `rpc`查询公共接口 -> 获取起源配置，元数据
## 3.2 协议转换适配
1. 过滤器适配：`filter`
2. rollup裁剪：适配`grouping sets`、`rollup`场景
3. 时间维处理：时间转换、磨平时间差异
4. 拆分维度：多场景拆分，如mtd, wtd, 当期值等
## 3.3 执行查询
### 3.3.1 构建逻辑执行计划
1. 构建start节点，绑定逻辑计划
2. 构建公共接口查询节点
	1. 该节点工作：
		1. `build`：拆分子查询 -> 生成构建SQL请求 -> 构建SQL -> 构建逻辑节点 -> 构建父子关系
		2. `generateSingleQueryContext`：过滤计算指标 -> 多粒度拆分 -> 公共接口路由 -> 对比查询复制 -> 时间维相关
3. 构建多粒度合并节点：按照维度、衍生指标分组 -> full merge
4. 构建数据合并节点
5. 构建计算指标运算节点
6. 构建衍生指标计算节点
7. 构建维度名称关联节点
8. 构建多子查询union节点
9. 构建end节点：处理结束的最终数据存放
### 3.3.2 逻辑计划优化
暂无
### 3.3.3 构建物理执行计划
1. 物理执行计划是对逻辑执行计划的复制，持有逻辑计划节点的信息，同时持有所有执行所需要的依赖服务
### 3.3.4 物理计划优化
暂无
### 3.3.5 物理计划执行
1. 物理节点：
```
创建线程类Worker：等待父节点执行完 -> 调用调用物理节点run方法
提交线程池-路由：依赖线程池管理服务，懒汉锁，提交物理计划到线程池  <- 内存计算线程池 
														<- NRT线程池 
														<- PDT线程池
```
