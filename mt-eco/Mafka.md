
美团内部的消息队列，基于apache kafka 0.9开发。是一个分布式、高可用、高性能的全托管式消息队列
# 消息队列中间件
1. 队列类型：
	1. 普通队列：基础消息队列，支持消息生产和消息消费
	2. 延时队列：消息延时一段时间再发送给消费者，场景：下单超时未支付则取消
2. 存储可靠性：多副本
3. 通讯可靠性：ACK
# 应用场景
1. 异步处理：生产者发送完消息后不用等待消费者响应。生产者发送到MQ上，消费者订阅或监听MQ
2. 系统解耦：生产者和消费者不用了解彼此
3. 流量削峰：接口处理能力有限的情况下，高峰流量可以先放入消息队列，后台处理
4. 发布/订阅模型：一条消息，可以广播给多个接收者
# 专有名词
![[Pasted image 20240425160255.png]]
1. Broken：存储实际消息，即一台服务器
2. Castle：中控调度，调度客户端应该去哪台broken上消费或者生产
3. clientSDK：业务api，生产或消费
4. partition：消息分片
5. replica：副本
6. topic：主题，用于标识队列

# 消息队列功能
定义：消息传输过程中保存消息的容器
## 系统解耦
举例：用户下单后不必调用商家接口，而是用户系统将订单写入消息队列，商家系统订阅消息队列取消息![[Pasted image 20240802152645.png]]
## 异步化
举例：用户注册，正常流程是注册信息写入数据库后，调用邮件系统和短信系统给用户发送邮件和短信。使用消息队列，写入数据库后，将消息写入消息队列，邮件系统和短信系统订阅消息队列再发送![[Pasted image 20240802152700.png]]
## 日志处理
日志生产客户端，将日志写入消息队列。日志处理应用，订阅并消费消息队列中的日志
## 削峰控流
举例：秒杀场景下，在应用前端配置消息队列。
- 用户请求首先放入消息队列中，如果消息队列长度超过最大数量，则丢弃后续请求
- 秒杀业务根据规则读取消息队列的消息再处理
在流量暴增情况下，消息队列有两种：
1. 业务上游消息队列，限速发送
2. 业务下游消息队列，限速执行
## mafka结构
![[Pasted image 20240802155854.png]]
1. Client：
	- Producer：生产者将数据发送到Castle topic对应的partition
	- Consumer：消费者从topic中读取数据，每条数据最终只能有一个消费者消费
2. Broker：每个broker是一个kafka服务器，储存数据
3. Topic：数据的类别，生产者和消费者按topic来读取数据，一个topic可能有多个partition
4. Partition：topic被分成多个分区，以实现数据的并行处理。每个分区在物理上都是有序的
5. Zookeeper：kafka集群使用zookeeper管理和协调组件。负责集群管理、选举主节点及存储配置信息
	- 主节点：是负责处理所有读写请求的broker，producer将数据写入主节点，consumer从主节点读取数据，主节点同时也将数据复制到从节点
	- 不同分区有不同主节点，即处理不同分区的读写请求的broker是不同的